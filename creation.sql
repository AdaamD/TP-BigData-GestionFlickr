

/***************************************************************************************************
                                        CREATION DES TABLES
***************************************************************************************************/

SET SERVEROUTPUT ON

CREATE TABLE UTILISATEUR (
IDUTIL NUMERIC (4,0),
NOM VARCHAR(30) CONSTRAINT NN_NOMUTIL NOT NULL,
PRENOM VARCHAR(30) CONSTRAINT NN_PRENOMUTIL NOT NULL,
    CONSTRAINT PK_UTILISATEUR PRIMARY KEY(IDUTIL)
);


CREATE TABLE APPAREIL (
IDAPP NUMERIC (4,0),
MARQUE VARCHAR(30) CONSTRAINT NN_MARQUEAPP NOT NULL,
    CONSTRAINT PK_APPAREIL PRIMARY KEY(IDAPP)
);


CREATE TABLE CONFIG (
IDCONF NUMERIC (4,0),
OUVERTURE_FOCALE VARCHAR(30) CONSTRAINT NN_OUVERTURE NOT NULL,
TEMPS_EXPO VARCHAR(30) CONSTRAINT NN_EXPO   NOT NULL , 
FLASH NUMERIC(4,0) CONSTRAINT CK_FLASH CHECK (FLASH =0 OR FLASH = 1), 
    CONSTRAINT PK_CONFIGURATION PRIMARY KEY(IDCONF)
);


CREATE TABLE CONTENU_NUMERIQUE(
IDCONTENU NUMERIC (4,0),
    CONSTRAINT PK_CONTENU_NUM PRIMARY KEY(IDCONTENU)
);


CREATE TABLE PHOTOGRAPHIE (
CODE NUMERIC (4,0),
LIEU_REALISATION VARCHAR(30) CONSTRAINT NN_LIEU NOT NULL,
DATE_REALISATION DATE CONSTRAINT NN_DATE NOT NULL,
IDAPPAREIL NUMERIC (4,0) CONSTRAINT NN_APPAREIL_PHOTO NOT NULL,
IDCONF NUMERIC (4,0) CONSTRAINT NN_CONFIG_PHOTO NOT NULL,
LICENCE VARCHAR(50) CONSTRAINT CK_LICENCE CHECK(LICENCE IN('tous droits reserves','utilisation commerciale autorisee','modifications de image autorisees')),
    CONSTRAINT PK_PHOTO PRIMARY KEY(CODE),
    CONSTRAINT FK_CONTENU_NUM FOREIGN KEY(CODE) REFERENCES CONTENU_NUMERIQUE(IDCONTENU) ON DELETE CASCADE,
    CONSTRAINT FK_APPAREIL FOREIGN KEY(IDAPPAREIL) REFERENCES APPAREIL(IDAPP) ON DELETE CASCADE,
    CONSTRAINT FK_CONFIGURATION FOREIGN KEY(IDCONF) REFERENCES CONFIG(IDCONF) ON DELETE CASCADE
);


CREATE TABLE COLLECT (
IDCOL NUMERIC (4,0),
NOM VARCHAR(30) CONSTRAINT NN_NOMCOLLECT NOT NULL,
IDPROPRIETAIRE_COLLECT NUMERIC (4,0) CONSTRAINT NN_PROPRIETAIRECOLLECT NOT NULL,
    CONSTRAINT PK_COLLECT PRIMARY KEY(IDCOL),
    CONSTRAINT FK_PROPRIETAIRE_COLLECT FOREIGN KEY(IDPROPRIETAIRE_COLLECT)REFERENCES UTILISATEUR(IDUTIL) ON DELETE CASCADE
);


CREATE TABLE ALBUM (
IDALB NUMERIC (4,0),
    CONSTRAINT PK_ALBUM PRIMARY KEY(IDALB),
    CONSTRAINT FK_ALBUM FOREIGN KEY(IDALB)REFERENCES COLLECT(IDCOL) ON DELETE CASCADE
);


CREATE TABLE GALERIE (
IDGAL NUMERIC (4,0),
    CONSTRAINT PK_GALERIE PRIMARY KEY(IDGAL),
    CONSTRAINT FK_GALERIE FOREIGN KEY(IDGAL)REFERENCES COLLECT(IDCOL) ON DELETE CASCADE
);


CREATE TABLE RANGER (
IDCOLLECTION NUMERIC (4,0),
CODEPHOTO NUMERIC (4,0),
    CONSTRAINT PK_RANGER PRIMARY KEY(IDCOLLECTION,CODEPHOTO),
    CONSTRAINT FK_COLLECT FOREIGN KEY(IDCOLLECTION)REFERENCES COLLECT(IDCOL) ON DELETE CASCADE,
    CONSTRAINT FK_PHOTOGRAPHIE FOREIGN KEY(CODEPHOTO)REFERENCES PHOTOGRAPHIE(CODE) ON DELETE CASCADE
);


CREATE TABLE DISCUSSION (
IDDIS NUMERIC (4,0),
    CONSTRAINT PK_DISCUSSION PRIMARY KEY(IDDIS)
);


CREATE TABLE AIME (
CODEPHOTOLIKE NUMERIC (4,0),
ID_UTIL_LIKE NUMERIC (4,0) CONSTRAINT NN_IDUTILISATEURLIKE NOT NULL,
    CONSTRAINT PK_LIKE PRIMARY KEY(CODEPHOTOLIKE,ID_UTIL_LIKE),
    CONSTRAINT FK_LIKE_PHOTO FOREIGN KEY(CODEPHOTOLIKE)REFERENCES     PHOTOGRAPHIE(CODE) ON DELETE CASCADE,
    CONSTRAINT FK_LIKE_UTILISATEUR FOREIGN KEY(ID_UTIL_LIKE)REFERENCES UTILISATEUR(IDUTIL) ON DELETE CASCADE
);


CREATE TABLE ABONNE (
ID_UTIL1 NUMERIC (4,0) CONSTRAINT NN_IDUTILISATEUR_ABON_1 NOT NULL,
ID_UTIL2 NUMERIC (4,0) CONSTRAINT NN_IDUTILISATEUR_ABON_2 NOT NULL,
    CONSTRAINT PK_ABONNE PRIMARY KEY(ID_UTIL1,ID_UTIL2),
    CONSTRAINT FK_ABONNE_UTILISATEUR1 FOREIGN KEY(ID_UTIL1)REFERENCES  UTILISATEUR(IDUTIL) ON DELETE CASCADE,
    CONSTRAINT FK_ABONNE_UTILISATEUR2 FOREIGN KEY(ID_UTIL2)REFERENCES
     UTILISATEUR(IDUTIL) ON DELETE CASCADE
);


CREATE TABLE VISUALISE (
CODEPHOTOVIS NUMERIC (4,0) CONSTRAINT NN_CODEPHOTOVIS NOT NULL,
IDUTIL_VIS NUMERIC (4,0) CONSTRAINT NN_IDUTILISATEURVIS NOT NULL,
    CONSTRAINT PK_VISUALISE PRIMARY KEY(CODEPHOTOVIS,IDUTIL_VIS),
    CONSTRAINT FK_VISUALISE_UTILISATEUR FOREIGN KEY(IDUTIL_VIS)REFERENCES UTILISATEUR(IDUTIL) ON DELETE CASCADE,
    CONSTRAINT FK_VISUALISE_PHOTO FOREIGN KEY(CODEPHOTOVIS)REFERENCES PHOTOGRAPHIE(CODE) ON DELETE CASCADE
);


CREATE TABLE PUBLIE (
CODEPHOTOPUB NUMERIC (4,0) CONSTRAINT NN_CODEPHOTOPUB NOT NULL,
DATEPUB DATE  CONSTRAINT NN_DATEPUB NOT NULL,
IDUTIL_PUB NUMERIC (4,0) CONSTRAINT NN_IDUTILISATEURPUB NOT NULL,
    CONSTRAINT PK_PUBLIE PRIMARY KEY(CODEPHOTOPUB,IDUTIL_PUB),
    CONSTRAINT FK_PUB_UTILISATEUR FOREIGN KEY(IDUTIL_PUB)REFERENCES UTILISATEUR(IDUTIL) ON DELETE CASCADE,
    CONSTRAINT FK_PUB_PHOTO FOREIGN KEY(CODEPHOTOPUB)REFERENCES  PHOTOGRAPHIE(CODE) ON DELETE CASCADE
);


CREATE TABLE COMMENTAIRE (
IDCOMMENTAIRE NUMERIC (4,0),
DIS_COM NUMERIC (4,0),
TEXTE VARCHAR(50) CONSTRAINT NN_TEXTECOMMENTAIRE NOT NULL,
CODEPHOTOCOM NUMERIC (4,0) CONSTRAINT NN_CODEPHOTOCOM NOT NULL,
IDUTIL_COM NUMERIC (4,0) CONSTRAINT NN_IDUTILISATEURCOM NOT NULL,
    CONSTRAINT PK_COMMENTAIRE PRIMARY KEY(IDCOMMENTAIRE),
    CONSTRAINT FK_CONTENU_NUM_COM FOREIGN KEY(IDCOMMENTAIRE)
    REFERENCES CONTENU_NUMERIQUE(IDCONTENU) ON DELETE CASCADE,
    CONSTRAINT FK_DISCUSSION_COM FOREIGN KEY(DIS_COM)REFERENCES DISCUSSION(IDDIS) ON DELETE CASCADE,
    CONSTRAINT FK_COMMENTAIRE_PHOTO FOREIGN KEY(CODEPHOTOCOM)REFERENCES PHOTOGRAPHIE(CODE) ON DELETE CASCADE,
    CONSTRAINT FK_COMMENTAIRE_UTILISATEUR FOREIGN KEY(IDUTIL_COM)REFERENCES UTILISATEUR(IDUTIL) ON DELETE CASCADE
);


CREATE TABLE BALISE (
TYPE_BALISE VARCHAR(40),
    CONSTRAINT PK_BALISE PRIMARY KEY(TYPE_BALISE)
);


CREATE TABLE MARQUER (
BALISE_MARQUER VARCHAR(40),
CODEPHOTOMARQUER NUMERIC (4,0) CONSTRAINT NN_CODEPHOTOMAR NOT NULL,
IDUTIL_MARQUER NUMERIC (4,0) CONSTRAINT NN_IDUTILISATEURMAR NOT NULL,
    CONSTRAINT PK_MARQUER PRIMARY KEY(BALISE_MARQUER,CODEPHOTOMARQUER,IDUTIL_MARQUER),
    CONSTRAINT FK_MAR_UTILISATEUR FOREIGN KEY(IDUTIL_MARQUER)REFERENCES UTILISATEUR(IDUTIL) ON DELETE CASCADE,
    CONSTRAINT FK_MAR_PHOTO FOREIGN KEY(CODEPHOTOMARQUER)REFERENCES PHOTOGRAPHIE(CODE) ON DELETE CASCADE,
    CONSTRAINT FK_MAR_BALISE FOREIGN KEY(BALISE_MARQUER)REFERENCES BALISE(TYPE_BALISE) ON DELETE CASCADE
);


/***************************************************************************************************
                                        Triggers
***************************************************************************************************/


/*
-- Création du déclencheur BEFORE INSERT sur la table RANGER pour le rangement dans un album 
CREATE OR REPLACE TRIGGER check_album
BEFORE INSERT ON RANGER
FOR EACH ROW
DECLARE
 is_album INT;
 album_owner_id ALBUM.IDPROPRIETAIRE_COLLECT%TYPE; 
BEGIN
 -- Vérifiez si l'ID de collection (NEW.IDCOLLECTION) correspond à un album
 SELECT COUNT
 INTO is_album
 FROM ALBUM
 WHERE IDALB = :new.IDCOLLECTION;

 -- Si c'est un album, vérifiez que l'utilisateur est le propriétaire de l'album
 IF is_album = 1 THEN
 -- Sélectionnez l'ID du propriétaire de l'album
 SELECT IDPROPRIETAIRE_COLLECT
 INTO album_owner_id
 FROM COLLECT
 WHERE IDCOL = :new.IDCOLLECTION;

 -- Vérifiez si l'utilisateur est le propriétaire de l'album
 IF :NEW.IDUTILISATEUR <> album_owner_id THEN
 RAISE_APPLICATION_ERROR(-20001, 'Seul le propriétaire de l''album peut ranger des photos dans cet album.');
 END IF;
 END IF;
END;
/
*/




/***************************************************************************************************
                                        REMPLISSAGE DE LA BASE
***************************************************************************************************/


 
INSERT INTO UTILISATEUR VALUES (0001 , 'DURAND' , 'Lucas' ) ;
INSERT INTO UTILISATEUR VALUES (0002 , 'TURING' , 'Alan' ) ;
INSERT INTO UTILISATEUR VALUES (0003 , 'MARIZ' , 'Julie' ) ;
INSERT INTO UTILISATEUR VALUES (0004 , 'MARIA' , 'Rose' ) ;
INSERT INTO UTILISATEUR VALUES (0005 , 'TOTO' , 'PAUL' ) ;


INSERT INTO APPAREIL VALUES (1000 , 'HP' ) ;
INSERT INTO APPAREIL VALUES (1001 , 'APPLE' ) ;
INSERT INTO APPAREIL VALUES (1002 , 'KANON' ) ;
INSERT INTO APPAREIL VALUES (1003 , 'NOKIA' ) ;
INSERT INTO APPAREIL VALUES (1004 , 'ASUS' ) ;


INSERT INTO CONFIG VALUES (2000 , '1234mm' , '0.1s' , 0) ;
INSERT INTO CONFIG VALUES (2001 , '9876mm' , '2.0s' , 0) ;
INSERT INTO CONFIG VALUES (2002 , '6547mm' , '0.1s' , 1) ;
INSERT INTO CONFIG VALUES (2003 , '0324mm' , '2.5s' , 1) ;
INSERT INTO CONFIG VALUES (2004 , '4710mm' , '1.6s' , 1) ;


INSERT INTO CONTENU_NUMERIQUE VALUES (3000  ) ;
INSERT INTO CONTENU_NUMERIQUE VALUES (3001  ) ;
INSERT INTO CONTENU_NUMERIQUE VALUES (3002  ) ;
INSERT INTO CONTENU_NUMERIQUE VALUES (3003  ) ;
INSERT INTO CONTENU_NUMERIQUE VALUES (3004  ) ;
INSERT INTO CONTENU_NUMERIQUE VALUES (3005  ) ;

INSERT INTO CONTENU_NUMERIQUE VALUES (3100  ) ;
INSERT INTO CONTENU_NUMERIQUE VALUES (3101  ) ;
INSERT INTO CONTENU_NUMERIQUE VALUES (3102 ) ;
INSERT INTO CONTENU_NUMERIQUE VALUES (3103 ) ;
INSERT INTO CONTENU_NUMERIQUE VALUES (3104  ) ;
INSERT INTO CONTENU_NUMERIQUE VALUES (3105  ) ;


INSERT INTO PHOTOGRAPHIE VALUES (3000 , 'Montpellier' , '19/09/2022' ,1000, 2000 ,'tous droits reserves') ;
INSERT INTO PHOTOGRAPHIE VALUES (3001 , 'Toulouse' , '29/10/2023' ,1000, 2000 ,'modifications de image autorisees') ;
INSERT INTO PHOTOGRAPHIE VALUES (3002 , 'Marseille' ,'12/01/2023' ,1000, 2001 ,'utilisation commerciale autorisee') ;
INSERT INTO PHOTOGRAPHIE VALUES (3003 , 'Montpellier' ,'14/02/2023' ,1002, 2004 ,'tous droits reserves') ;
INSERT INTO PHOTOGRAPHIE VALUES (3004 , 'Montpellier' , '14/02/2022' ,1003, 2001 ,'tous droits reserves') ;
INSERT INTO PHOTOGRAPHIE VALUES (3005 , 'Montpellier' ,'27/07/2023' ,1002, 2003 ,'tous droits reserves') ;


INSERT INTO COLLECT VALUES (4000 , 'Animaux', 0001) ;
INSERT INTO COLLECT VALUES (4001 , 'Voitures',0001 ) ;
INSERT INTO COLLECT VALUES (4002 , 'Nature',0002 ) ;
INSERT INTO COLLECT VALUES (4003 , 'Mode',0003 ) ;
INSERT INTO COLLECT VALUES (4004 , 'Sport' ,0004) ;


INSERT INTO ALBUM VALUES (4000  ) ;
INSERT INTO ALBUM VALUES (4001  ) ;
INSERT INTO ALBUM VALUES (4002  ) ;
INSERT INTO ALBUM VALUES (4004  ) ;


INSERT INTO GALERIE VALUES (4000  ) ;
INSERT INTO GALERIE VALUES (4001  ) ;
INSERT INTO GALERIE VALUES (4002  ) ;
INSERT INTO GALERIE VALUES (4003  ) ;


INSERT INTO RANGER VALUES (4000, 3000  ) ;
INSERT INTO RANGER VALUES (4001, 3000  ) ;
INSERT INTO RANGER VALUES (4002, 3000  ) ;

INSERT INTO RANGER VALUES (4000, 3003  ) ;
INSERT INTO RANGER VALUES (4002, 3001  ) ;
INSERT INTO RANGER VALUES (4001, 3002  ) ;
INSERT INTO RANGER VALUES (4004, 3004  ) ;


INSERT INTO DISCUSSION VALUES (5000  ) ;
INSERT INTO DISCUSSION VALUES (5001  ) ;
INSERT INTO DISCUSSION VALUES (5002  ) ;
INSERT INTO DISCUSSION VALUES (5003  ) ;
INSERT INTO DISCUSSION VALUES (5004  ) ;
INSERT INTO DISCUSSION VALUES (5005 ) ;


INSERT INTO AIME VALUES (3000,0001  ) ;
INSERT INTO AIME VALUES (3000,0003  ) ;
INSERT INTO AIME VALUES (3000,0005  ) ;

INSERT INTO AIME VALUES (3002,0002  ) ;
INSERT INTO AIME VALUES (3002,0004  ) ;

INSERT INTO AIME VALUES (3004,0004  ) ;

INSERT INTO AIME VALUES (3005,0001  ) ;
INSERT INTO AIME VALUES (3005,0002  ) ;
INSERT INTO AIME VALUES (3005,0003  ) ;
INSERT INTO AIME VALUES (3005,0004  ) ;


INSERT INTO ABONNE VALUES (0001,0002  ) ;
INSERT INTO ABONNE VALUES (0001,0003  ) ;
INSERT INTO ABONNE VALUES (0001,0004  ) ;
INSERT INTO ABONNE VALUES (0001,0005  ) ;

INSERT INTO ABONNE VALUES (0002,0004  ) ;

INSERT INTO ABONNE VALUES (0004,0005  ) ;

INSERT INTO ABONNE VALUES (0003,0001  ) ;


INSERT INTO VISUALISE VALUES (3000,0001  ) ;
INSERT INTO VISUALISE VALUES (3000,0002  ) ;
INSERT INTO VISUALISE VALUES (3000,0003  ) ;
INSERT INTO VISUALISE VALUES (3000,0004  ) ;

INSERT INTO VISUALISE VALUES (3001,0001  ) ;
INSERT INTO VISUALISE VALUES (3001,0003  ) ;
INSERT INTO VISUALISE VALUES (3001,0004  ) ;

INSERT INTO VISUALISE VALUES (3002,0001  ) ;

INSERT INTO VISUALISE VALUES (3004,0002  ) ;
INSERT INTO VISUALISE VALUES (3004,0004  ) ;


INSERT INTO PUBLIE VALUES (3000,'11/02/2022',0001  ) ;
INSERT INTO PUBLIE VALUES (3001,'21/12/2020',0001  ) ;

INSERT INTO PUBLIE VALUES (3002,'07/07/2023',0002  ) ;

INSERT INTO PUBLIE VALUES (3003,'25/07/2022',0003  ) ;

INSERT INTO PUBLIE VALUES (3004,'30/11/2021',0004  ) ;

INSERT INTO PUBLIE VALUES (3005,'26/06/2022',0005  ) ;

INSERT INTO COMMENTAIRE VALUES (3100,5000,'jolie photo', 3000,0004  ) ;
INSERT INTO COMMENTAIRE VALUES (3105,5005,'sublime', 3000,0002  ) ;
INSERT INTO COMMENTAIRE VALUES (3101,5001,'une merveille la ville rose', 3001,0002  ) ;
INSERT INTO COMMENTAIRE VALUES (3102,5002,'vous auriez du utiliser le flash', 3002,0003  ) ;
INSERT INTO COMMENTAIRE VALUES (3103,5003,'très belle plage !!!!', 3003,0001  ) ;
INSERT INTO COMMENTAIRE VALUES (3104,5004,'quelle prise ', 3004,0004  ) ;


INSERT INTO BALISE VALUES ('plage' ) ;
INSERT INTO BALISE VALUES ('Toulouse' ) ;
INSERT INTO BALISE VALUES ('tigre' ) ;


INSERT INTO MARQUER VALUES ('plage',3003,0001 ) ;
INSERT INTO MARQUER VALUES ('Toulouse',3001,0001 ) ;
INSERT INTO MARQUER VALUES ('tigre',3004,0004) ;




